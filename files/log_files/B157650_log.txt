

	####### B157650 R script #######

rm(list = ls())
[1] 1
library(ggplot2, quietly = T)
[1] 2
[1] "ggplot2"   "readr"     "stats"     "graphics"  "grDevices" "utils"     "datasets"  "methods"   "base"     
library(dplyr, quietly = T)
[1] 3
 [1] "dplyr"     "ggplot2"   "readr"     "stats"     "graphics"  "grDevices" "utils"     "datasets"  "methods"   "base"     
library(gridExtra, quietly = T)
[1] 4
 [1] "gridExtra" "dplyr"     "ggplot2"   "readr"     "stats"     "graphics"  "grDevices" "utils"     "datasets"  "methods"  
[11] "base"     
library(lsr, quietly = T)
[1] 5
 [1] "lsr"       "gridExtra" "dplyr"     "ggplot2"   "readr"     "stats"     "graphics"  "grDevices" "utils"     "datasets" 
[11] "methods"   "base"     
library(car, quietly = T)
[1] 6
 [1] "car"       "carData"   "lsr"       "gridExtra" "dplyr"     "ggplot2"   "readr"     "stats"     "graphics"  "grDevices"
[11] "utils"     "datasets"  "methods"   "base"     
library(stringr, quietly = T)
[1] 7
 [1] "stringr"   "car"       "carData"   "lsr"       "gridExtra" "dplyr"     "ggplot2"   "readr"     "stats"     "graphics" 
[11] "grDevices" "utils"     "datasets"  "methods"   "base"     
out_index <- function(x) {
    (x < mean(x, na.rm = T) - sd(x, na.rm = T) * 3) | (x > mean(x, 
        na.rm = T) + sd(x, na.rm = T) * 3)
}
[1] 8
diagnostic_plots <- function(m) {
    p1 <- ggplot(m, aes(.fitted, .resid)) + geom_point(shape = 1, 
        size = 2, alpha = 0.75) + stat_smooth(method = "loess", 
        se = F, col = "red", size = 1) + geom_hline(yintercept = 0, 
        linetype = "dashed") + labs(title = "(a) Residuals v.s. Fitted Plot", 
        x = "Fitted Values", y = "Residuals") + theme_classic() + 
        theme(plot.title = element_text(hjust = 0.5), text = element_text(family = "serif", 
            size = 10))
    p2 <- ggplot(m, aes(qqnorm(.stdresid)[[1]], .stdresid)) + 
        geom_point(shape = 1, size = 2, alpha = 0.75) + geom_qq_line(aes(sample = rstandard(m)), 
        linetype = "dashed", alpha = 0.5) + labs(title = "(b) Normal Q-Q Plot", 
        x = "Theoretical Quantiles", y = "Standardised Residuals") + 
        theme_classic() + theme(plot.title = element_text(hjust = 0.5), 
        text = element_text(family = "serif", size = 10))
    p3 <- ggplot(m, aes(.fitted, sqrt(abs(.stdresid)))) + geom_point(shape = 1, 
        size = 2, alpha = 0.75) + stat_smooth(method = "loess", 
        se = F, na.rm = T, col = "red") + labs(title = "(c) Scale-Location Plot", 
        x = "Fitted Values", y = expression(sqrt("|Standardised Residuals|"))) + 
        theme_classic() + theme(plot.title = element_text(hjust = 0.5), 
        text = element_text(family = "serif", size = 10))
    p4 <- ggplot(m, aes(seq_along(.cooksd), .cooksd)) + geom_bar(stat = "identity", 
        position = "identity", width = 0.5) + labs(title = "(d) Cook's Distance Plot", 
        x = "Observation Number", y = "Cook's Distance") + theme_classic() + 
        theme(plot.title = element_text(hjust = 0.5), text = element_text(family = "serif", 
            size = 10))
    grid.arrange(p1, p2, p3, p4, nrow = 2)
}
[1] 9
load(url("https://edin.ac/2QCZNVu"))
[1] 10
[1] "drinkdriving" "officer_inc" 
str(drinkdriving)
[1] 11
Classes ‘tbl_df’, ‘tbl’ and 'data.frame':	250 obs. of  7 variables:
 $ age          : num  39 28 38 51 56 36 81 49 32 60 ...
 $ nighttime    : chr  "night" "day" "night" "night" ...
 $ prior_offence: chr  "N" "N" "DR50" "N" ...
 $ speed        : num  47.96 43.83 47.26 17.22 1.95 ...
 $ bac          : num  17.7 22.1 32.8 20.5 29.4 ...
 $ outcome      : chr  "fine" "fine" "fine" "warning" ...
 $ incident_id  : chr  "inc_1" "inc_2" "inc_3" "inc_4" ...
NULL
summary(drinkdriving)
[1] 12
      age          nighttime         prior_offence          speed             bac           outcome          incident_id       
 Min.   : 14.00   Length:250         Length:250         Min.   :  0.00   Min.   : 3.987   Length:250         Length:250        
 1st Qu.: 30.00   Class :character   Class :character   1st Qu.: 30.92   1st Qu.:19.264   Class :character   Class :character  
 Median : 40.50   Mode  :character   Mode  :character   Median : 40.64   Median :23.609   Mode  :character   Mode  :character  
 Mean   : 46.00                                         Mean   : 40.49   Mean   :23.605                                        
 3rd Qu.: 55.25                                         3rd Qu.: 48.84   3rd Qu.:27.898                                        
 Max.   :297.00                                         Max.   :120.34   Max.   :65.764                                        
 NA's   :22                                                              NA's   :5                                             
drinkdriving$age[drinkdriving$age > 200] <- NA
[1] 13
drinkdriving$nighttime[!(drinkdriving$nighttime %in% c("day", 
    "night"))] <- NA
[1] 14
drinkdriving$nighttime <- as.factor(drinkdriving$nighttime)
[1] 15
drinkdriving$prior_offence <- as.factor(drinkdriving$prior_offence)
[1] 16
drinkdriving$speed[out_index(drinkdriving$speed)] <- NA
[1] 17
drinkdriving$bac[out_index(drinkdriving$bac)] <- NA
[1] 18
drinkdriving$outcome <- as.factor(tolower(drinkdriving$outcome))
[1] 19
drinkdriving$incident_id <- as.factor(drinkdriving$incident_id)
[1] 20
str(officer_inc)
[1] 21
'data.frame':	250 obs. of  2 variables:
 $ officer    : Factor w/ 3 levels "AS","IT","NP": 1 2 2 1 2 1 1 1 2 1 ...
 $ incident_id: Factor w/ 250 levels "inc_1","inc_10",..: 100 197 67 88 95 110 170 222 30 45 ...
NULL
table(officer_inc$officer)
[1] 22

 AS  IT  NP 
116  66  67 
m1 <- lm(bac ~ age, data = drinkdriving)
[1] 23
diagnostic_plots(m1)
[1] 24
summary(m1)
[1] 25

Call:
lm(formula = bac ~ age, data = drinkdriving)

Residuals:
     Min       1Q   Median       3Q      Max 
-15.3270  -4.1824  -0.5698   3.9975  14.9487 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)    
(Intercept) 28.68503    1.06949   26.82  < 2e-16 ***
age         -0.13730    0.02331   -5.89 1.47e-08 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 5.791 on 216 degrees of freedom
  (32 observations deleted due to missingness)
Multiple R-squared:  0.1384,	Adjusted R-squared:  0.1344 
F-statistic: 34.69 on 1 and 216 DF,  p-value: 1.469e-08

standardCoefs(m1)
[1] 26
             b       beta
age -0.1373039 -0.3719763
predict(m1, newdata = data.frame(age = 50))
[1] 27
       1 
21.81983 
ggplot(m1, aes(qqnorm(.stdresid)[[1]], .stdresid)) + geom_point(shape = 1, 
    size = 2, alpha = 0.75) + geom_qq_line(aes(sample = rstandard(m1)), 
    linetype = "dashed", alpha = 0.5) + labs(x = "Theoretical Quantiles", 
    y = "Standardised Residuals") + theme_classic() + theme(plot.title = element_text(hjust = 0.5), 
    text = element_text(family = "serif", size = 10))
[1] 28
m2 <- lm(bac ~ age + nighttime + speed, data = drinkdriving)
[1] 29
summary(m2)
[1] 30

Call:
lm(formula = bac ~ age + nighttime + speed, data = drinkdriving)

Residuals:
     Min       1Q   Median       3Q      Max 
-15.6457  -4.3757   0.5792   3.5662  14.2890 

Coefficients:
               Estimate Std. Error t value Pr(>|t|)    
(Intercept)    23.52651    2.66327   8.834 3.89e-16 ***
age            -0.11596    0.02990  -3.878 0.000141 ***
nighttimenight  3.87648    0.79353   4.885 2.04e-06 ***
speed           0.04110    0.03958   1.038 0.300244    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 5.416 on 212 degrees of freedom
  (34 observations deleted due to missingness)
Multiple R-squared:  0.246,	Adjusted R-squared:  0.2353 
F-statistic: 23.05 on 3 and 212 DF,  p-value: 5.894e-13

standardCoefs(m2)
[1] 31
                         b        beta
age            -0.11595910 -0.31441433
nighttimenight  3.87647837  0.29249496
speed           0.04110277  0.08398321
anova(m2)
[1] 32
Analysis of Variance Table

Response: bac
           Df Sum Sq Mean Sq F value    Pr(>F)    
age         1 1300.0 1299.99 44.3147 2.354e-10 ***
nighttime   1  697.3  697.27 23.7690 2.128e-06 ***
speed       1   31.6   31.63  1.0784    0.3002    
Residuals 212 6219.1   29.34                      
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
diagnostic_plots(m2)
[1] 33
vif(m2)
[1] 34
      age nighttime     speed 
 1.848306  1.007976  1.838954 
m2_2 <- lm(bac ~ age + nighttime, data = drinkdriving)
[1] 35
summary(m2_2)
[1] 36

Call:
lm(formula = bac ~ age + nighttime, data = drinkdriving)

Residuals:
     Min       1Q   Median       3Q      Max 
-16.3421  -4.3987   0.2997   3.7390  14.4090 

Coefficients:
               Estimate Std. Error t value Pr(>|t|)    
(Intercept)    26.00346    1.18497  21.944  < 2e-16 ***
age            -0.13690    0.02209  -6.199 2.91e-09 ***
nighttimenight  3.86857    0.79364   4.874 2.13e-06 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 5.417 on 213 degrees of freedom
  (34 observations deleted due to missingness)
Multiple R-squared:  0.2422,	Adjusted R-squared:  0.235 
F-statistic: 34.03 on 2 and 213 DF,  p-value: 1.498e-13

standardCoefs(m2_2)
[1] 37
                        b       beta
age            -0.1368982 -0.3711892
nighttimenight  3.8685730  0.2918985
diagnostic_plots(m2_2)
[1] 38
vif(m2_2)
[1] 39
      age nighttime 
 1.007883  1.007883 
speed_day <- drinkdriving$speed[drinkdriving$nighttime == "day"]
[1] 40
speed_night <- drinkdriving$speed[drinkdriving$nighttime == "night"]
[1] 41
shapiro.test(speed_day)
[1] 42

	Shapiro-Wilk normality test

data:  speed_day
W = 0.98774, p-value = 0.6719

shapiro.test(speed_night)
[1] 43

	Shapiro-Wilk normality test

data:  speed_night
W = 0.99385, p-value = 0.702

t.test(speed_day, speed_night, alternative = "less")
[1] 44

	Welch Two Sample t-test

data:  speed_day and speed_night
t = -1.5101, df = 195.84, p-value = 0.06631
alternative hypothesis: true difference in means is less than 0
95 percent confidence interval:
     -Inf 0.245475
sample estimates:
mean of x mean of y 
 38.25278  40.85289 

drinkdriving$outcome <- factor(as.character(drinkdriving$outcome), 
    levels = c("warning", "fine"))
[1] 45
m3 <- glm(outcome ~ age + nighttime + prior_offence + speed + 
    bac, data = drinkdriving, family = "binomial")
[1] 46
summary(m3)
[1] 47

Call:
glm(formula = outcome ~ age + nighttime + prior_offence + speed + 
    bac, family = "binomial", data = drinkdriving)

Deviance Residuals: 
     Min        1Q    Median        3Q       Max  
-3.15025   0.00186   0.03577   0.19445   3.01257  

Coefficients:
                         Estimate Std. Error z value Pr(>|z|)    
(Intercept)              20.72778 4336.30018   0.005 0.996186    
age                      -0.13783    0.03775  -3.651 0.000261 ***
nighttimenight           -0.69684    0.77689  -0.897 0.369742    
prior_offenceCD60       -46.80580 7832.51612  -0.006 0.995232    
prior_offenceDD20       -28.74520 4336.29995  -0.007 0.994711    
prior_offenceDR50       -20.28837 4336.29938  -0.005 0.996267    
prior_offenceDR80       -27.37755 4336.29995  -0.006 0.994963    
prior_offenceN          -22.88474 4336.29927  -0.005 0.995789    
prior_offencePL10       -20.82691 4336.56091  -0.005 0.996168    
prior_offenceSP50       -11.17557 6049.48707  -0.002 0.998526    
 [ reached getOption("max.print") -- omitted 5 rows ]
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 215.618  on 215  degrees of freedom
Residual deviance:  62.071  on 201  degrees of freedom
  (34 observations deleted due to missingness)
AIC: 92.071

Number of Fisher Scoring iterations: 17

e_speed <- exp(m3$coefficients["speed"] * sd(m3$model$speed))
[1] 48
e_bac <- exp(m3$coefficients["bac"] * sd(m3$model$bac))
[1] 49
c(e_speed, e_bac)
[1] 50
   speed      bac 
5.853501 7.345279 
drinkdriving$prior_offence_type <- ifelse(drinkdriving$prior_offence == 
    "N", "N", ifelse(str_detect(drinkdriving$prior_offence, "DR50"), 
    "D", "ND"))
[1] 51
drinkdriving$prior_offence_type <- as.factor(drinkdriving$prior_offence_type)
[1] 52
contrasts(drinkdriving$prior_offence_type) <- cbind(DvND = c(1/2, 
    0, -1/2), AvN = c(1/3, -2/3, 1/3))
[1] 53
m4 <- glm(outcome ~ prior_offence_type, data = drinkdriving, 
    family = "binomial")
[1] 54
summary(m4)
[1] 55

Call:
glm(formula = outcome ~ prior_offence_type, family = "binomial", 
    data = drinkdriving)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.1899   0.4366   0.6681   0.6681   0.9005  

Coefficients:
                       Estimate Std. Error z value Pr(>|z|)    
(Intercept)              1.4607     0.2411   6.060 1.36e-09 ***
prior_offence_typeDvND   1.6094     0.6994   2.301   0.0214 *  
prior_offence_typeAvN    0.1116     0.3951   0.282   0.7776    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 244.56  on 249  degrees of freedom
Residual deviance: 238.69  on 247  degrees of freedom
AIC: 244.69

Number of Fisher Scoring iterations: 4

age <- 17:70
[1] 56
new <- data.frame(age = age, nighttime = as.factor(rep("day", 
    length(age))), prior_offence = as.factor(rep("N", length(age))), 
    speed = rep(30, length(age)), bac = rep(0, length(age)))
[1] 57
new$pred <- predict.glm(m3, newdata = new, type = "response")
[1] 58
ggplot(data = new, aes(x = age, y = pred)) + geom_point(shape = 1, 
    size = 2, alpha = 0.8) + geom_line(col = "blue", alpha = 0.8) + 
    labs(x = "Age (year)", y = "Predicted Probabilities for Receiving a Fine") + 
    theme_classic() + theme(plot.title = element_text(hjust = 0.5), 
    text = element_text(family = "serif", size = 10))
[1] 59
drinkdriving <- drinkdriving[order(drinkdriving$incident_id), 
    ]
[1] 60
officer_inc <- officer_inc[order(officer_inc$incident_id), ]
[1] 61
drinkdriving$officer <- officer_inc$officer
[1] 62
m_AS <- glm(outcome ~ age, family = "binomial", data = drinkdriving[drinkdriving$officer == 
    "AS", ])
[1] 63
summary(m_AS)
[1] 64

Call:
glm(formula = outcome ~ age, family = "binomial", data = drinkdriving[drinkdriving$officer == 
    "AS", ])

Deviance Residuals: 
     Min        1Q    Median        3Q       Max  
-2.12735   0.04562   0.11748   0.29394   2.40895  

Coefficients:
            Estimate Std. Error z value Pr(>|z|)    
(Intercept)  9.56920    1.99554   4.795 1.62e-06 ***
age         -0.16122    0.03466  -4.652 3.29e-06 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 109.187  on 107  degrees of freedom
Residual deviance:  50.047  on 106  degrees of freedom
  (9 observations deleted due to missingness)
AIC: 54.047

Number of Fisher Scoring iterations: 7

exp(m_AS$coefficients["age"])
[1] 65
      age 
0.8511019 
m_IT <- glm(outcome ~ age, family = "binomial", data = drinkdriving[drinkdriving$officer == 
    "IT", ])
[1] 66
summary(m_IT)
[1] 67

Call:
glm(formula = outcome ~ age, family = "binomial", data = drinkdriving[drinkdriving$officer == 
    "IT", ])

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.4543   0.2422   0.4630   0.6404   1.6544  

Coefficients:
            Estimate Std. Error z value Pr(>|z|)    
(Intercept)  4.52384    1.32631   3.411 0.000648 ***
age         -0.06510    0.02467  -2.639 0.008308 ** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 59.139  on 57  degrees of freedom
Residual deviance: 50.139  on 56  degrees of freedom
  (9 observations deleted due to missingness)
AIC: 54.139

Number of Fisher Scoring iterations: 5

exp(m_IT$coefficients["age"])
[1] 68
      age 
0.9369726 
m_NP <- glm(outcome ~ age, family = "binomial", data = drinkdriving[drinkdriving$officer == 
    "NP", ])
[1] 69
summary(m_NP)
[1] 70

Call:
glm(formula = outcome ~ age, family = "binomial", data = drinkdriving[drinkdriving$officer == 
    "NP", ])

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.7179   0.2653   0.4065   0.6138   1.1125  

Coefficients:
            Estimate Std. Error z value Pr(>|z|)   
(Intercept)  4.88454    1.48737   3.284  0.00102 **
age         -0.06757    0.02719  -2.485  0.01296 * 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 53.699  on 58  degrees of freedom
Residual deviance: 46.224  on 57  degrees of freedom
  (9 observations deleted due to missingness)
AIC: 50.224

Number of Fisher Scoring iterations: 5

exp(m_NP$coefficients["age"])
[1] 71
      age 
0.9346615 
