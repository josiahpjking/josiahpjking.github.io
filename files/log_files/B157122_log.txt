

	####### B157122 R script #######

library(ggplot2, quietly = T)
[1] 1
[1] "ggplot2"   "readr"     "stats"     "graphics"  "grDevices" "utils"     "datasets"  "methods"   "base"     
library(psych, quietly = T)
[1] 2
 [1] "psych"     "ggplot2"   "readr"     "stats"     "graphics"  "grDevices" "utils"     "datasets"  "methods"   "base"     
library(dplyr, quietly = T)
[1] 3
 [1] "dplyr"     "psych"     "ggplot2"   "readr"     "stats"     "graphics"  "grDevices" "utils"     "datasets"  "methods"  
[11] "base"     
load(url("https://edin.ac/2QCZNVu"))
[1] 4
[1] "drinkdriving" "officer_inc" 
ls()
[1] 5
 [1] "author_no"         "basic_pckgs"       "code_run"          "collab_list"       "collabs"           "comments"         
 [7] "drinkdriving"      "edit.script"       "error_log"         "files"             "ii"                "installed_pckgs"  
[13] "ll"                "log_file"          "models"            "n_lines_flag"      "n_model_flag"      "nn"               
[19] "not_run"           "officer_inc"       "p"                 "pckgs"             "plot_index"        "script"           
[25] "start"             "temp"              "undeclared_collab"
describe(drinkdriving)
[1] 6
               vars   n mean    sd median trimmed   mad min  max range skew kurtosis   se
age               1 228   46 33.35   40.5   42.34 18.53  14  297   283  5.5    38.49 2.21
nighttime*        2 250  NaN    NA     NA     NaN    NA Inf -Inf  -Inf   NA       NA   NA
prior_offence*    3 250  NaN    NA     NA     NaN    NA Inf -Inf  -Inf   NA       NA   NA
 [ reached 'max' / getOption("max.print") -- omitted 4 rows ]
drinkdriving$incident_id <- factor(drinkdriving$incident_id)
[1] 7
drinkdriving$outcome <- factor(drinkdriving$outcome)
[1] 8
drinkdriving$prior_offence <- factor(drinkdriving$prior_offence)
[1] 9
drinkdriving$nighttime <- factor(drinkdriving$nighttime)
[1] 10
drinkdriving$age[drinkdriving$age > 100] <- NA
[1] 11
drinkdriving$age[drinkdriving$age < 17] <- NA
[1] 12
drinkdriving$nighttime[drinkdriving$nighttime == "18:25"] <- "night"
[1] 13
drinkdriving$nighttime[drinkdriving$nighttime == "2:05"] <- NA
[1] 14
drinkdriving$outcome <- tolower(drinkdriving$outcome)
[1] 15
outliers <- function(obs, x = 2.5) {
    return(abs(obs - mean(obs, na.rm = T)) > (sd(obs, na.rm = T) * 
        x))
}
[1] 16
drinkdriving$bac[which(outliers(drinkdriving$bac))]
[1] 17
[1]  3.986785 57.330000 65.764000
drinkdriving$speed[which(outliers(drinkdriving$speed))]
[1] 18
[1]   1.945818   1.012149   2.533468 120.336960  81.028140   0.000000
levels(drinkdriving$prior_offence)
[1] 19
 [1] "CD10"           "CD60"           "CD60,CD10,DR80" "CD60,CD60"      "DD20"           "DR50"           "DR80"          
 [8] "N"              "PL10"           "SP50"           "SP60"           "TS70"           "TS70,DR50"     
drinkdriving$prior_offence <- revalue(drinkdriving$prior_offence, 
    c(CD10 = "CD", "CD60\"=\"CD", `CD60,CD10,DR80` = NA, `CD60,CD60` = "CD", 
        DD20 = NA, DR50 = "DR50", DR80 = "DR80", N = "N", PL10 = "PL", 
        SP50 = "SP", SP60 = "SP", TS70 = "TS", `TS70,DR50` = "DR50"))
[1] 20


####################################################################################################

[1] "Error in revalue(drinkdriving$prior_offence, c(CD10 = \"CD\", \"CD60\\\"=\\\"CD\",  : \n  could not find function \"revalue\"\n"
attr(,"class")
[1] "try-error"
attr(,"condition")
<simpleError in revalue(drinkdriving$prior_offence, c(CD10 = "CD", "CD60\"=\"CD",     `CD60,CD10,DR80` = NA, `CD60,CD60` = "CD", DD20 = NA, DR50 = "DR50",     DR80 = "DR80", N = "N", PL10 = "PL", SP50 = "SP", SP60 = "SP",     TS70 = "TS", `TS70,DR50` = "DR50")): could not find function "revalue">
####################################################################################################


levels(drinkdriving$prior_offence)
[1] 21
 [1] "CD10"           "CD60"           "CD60,CD10,DR80" "CD60,CD60"      "DD20"           "DR50"           "DR80"          
 [8] "N"              "PL10"           "SP50"           "SP60"           "TS70"           "TS70,DR50"     
drinkdriving <- merge(drinkdriving, officer_inc, all = TRUE)
[1] 22
drinkdriving <- drinkdriving[order(drinkdriving$bac), ]
[1] 23
m1 <- lm(bac ~ age, data = drinkdriving)
[1] 24
summary(m1)
[1] 25

Call:
lm(formula = bac ~ age, data = drinkdriving)

Residuals:
    Min      1Q  Median      3Q     Max 
-15.567  -4.490  -0.993   3.833  42.860 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)    
(Intercept) 28.84428    1.36250  21.170  < 2e-16 ***
age         -0.13501    0.02926  -4.614 6.86e-06 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 6.899 on 210 degrees of freedom
  (38 observations deleted due to missingness)
Multiple R-squared:  0.09205,	Adjusted R-squared:  0.08773 
F-statistic: 21.29 on 1 and 210 DF,  p-value: 6.86e-06

par(mfrow = c(2, 2))
[1] 26
$mfrow
[1] 2 2

plot(m1)
[1] 27
new_model <- data.frame(age = 50)
[1] 28
predict(m1, newdata = new_model)
[1] 29
       1 
22.09395 
plot(m1, which = 2)
[1] 30
m2 <- lm(bac ~ age + nighttime, data = drinkdriving)
[1] 31
anova(m2)
[1] 32
Analysis of Variance Table

Response: bac
           Df Sum Sq Mean Sq F value    Pr(>F)    
age         1 1146.1 1146.13  26.013 7.646e-07 ***
nighttime   1  586.5  586.54  13.312 0.0003337 ***
Residuals 207 9120.4   44.06                      
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
summary(m2)
[1] 33

Call:
lm(formula = bac ~ age + nighttime, data = drinkdriving)

Residuals:
    Min      1Q  Median      3Q     Max 
-16.528  -5.013  -0.006   3.522  41.730 

Coefficients:
               Estimate Std. Error t value Pr(>|t|)    
(Intercept)     26.4710     1.5250  17.358  < 2e-16 ***
age             -0.1368     0.0285  -4.800 3.04e-06 ***
nighttimenight   3.5825     0.9819   3.649 0.000334 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 6.638 on 207 degrees of freedom
  (40 observations deleted due to missingness)
Multiple R-squared:  0.1596,	Adjusted R-squared:  0.1515 
F-statistic: 19.66 on 2 and 207 DF,  p-value: 1.52e-08

par(mfrow = c(2, 2))
[1] 34
$mfrow
[1] 2 2

plot(m2)
[1] 35
m3 <- lm(bac ~ age + speed, data = drinkdriving)
[1] 36
summary(m3)
[1] 37

Call:
lm(formula = bac ~ age + speed, data = drinkdriving)

Residuals:
    Min      1Q  Median      3Q     Max 
-15.842  -4.488  -0.730   4.075  34.539 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)    
(Intercept) 16.96460    2.82919   5.996 8.76e-09 ***
age         -0.03450    0.03506  -0.984    0.326    
speed        0.19472    0.04120   4.726 4.21e-06 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 6.574 on 209 degrees of freedom
  (38 observations deleted due to missingness)
Multiple R-squared:  0.1797,	Adjusted R-squared:  0.1719 
F-statistic: 22.89 on 2 and 209 DF,  p-value: 1.022e-09

anova(m3)
[1] 38
Analysis of Variance Table

Response: bac
           Df Sum Sq Mean Sq F value    Pr(>F)    
age         1 1013.5 1013.51  23.454 2.487e-06 ***
speed       1  965.1  965.07  22.333 4.206e-06 ***
Residuals 209 9031.3   43.21                      
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
par(mfrow = c(2, 2))
[1] 39
$mfrow
[1] 2 2

plot(m3)
[1] 40
drinkdriving$speed[drinkdriving$speed > 80] <- NA
[1] 41
m3_revised <- lm(bac ~ age + speed, data = drinkdriving)
[1] 42
summary(m3_revised)
[1] 43

Call:
lm(formula = bac ~ age + speed, data = drinkdriving)

Residuals:
     Min       1Q   Median       3Q      Max 
-15.2141  -3.9350  -0.6521   4.1645  14.3229 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)    
(Intercept) 25.91438    2.83820   9.131  < 2e-16 ***
age         -0.10824    0.03289  -3.291  0.00117 ** 
speed        0.03698    0.04349   0.850  0.39608    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 5.838 on 207 degrees of freedom
  (40 observations deleted due to missingness)
Multiple R-squared:  0.1145,	Adjusted R-squared:  0.106 
F-statistic: 13.39 on 2 and 207 DF,  p-value: 3.407e-06

anova(m3_revised)
[1] 44
Analysis of Variance Table

Response: bac
           Df Sum Sq Mean Sq F value    Pr(>F)    
age         1  887.8  887.77 26.0514 7.512e-07 ***
speed       1   24.6   24.64  0.7232    0.3961    
Residuals 207 7054.1   34.08                      
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
par(mfrow = c(2, 2))
[1] 45
$mfrow
[1] 2 2

plot(m3_revised, which = c(1:4))
[1] 46
m4 <- lm(speed ~ nighttime, data = drinkdriving)
[1] 47
summary(m4)
[1] 48

Call:
lm(formula = speed ~ nighttime, data = drinkdriving)

Residuals:
    Min      1Q  Median      3Q     Max 
-40.702  -8.985   0.308   8.328  35.172 

Coefficients:
               Estimate Std. Error t value Pr(>|t|)    
(Intercept)      38.253      1.575  24.287   <2e-16 ***
nighttimenight    2.449      1.900   1.289    0.199    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 13.82 on 244 degrees of freedom
  (4 observations deleted due to missingness)
Multiple R-squared:  0.00676,	Adjusted R-squared:  0.002689 
F-statistic: 1.661 on 1 and 244 DF,  p-value: 0.1987

anova(m4, test = "Chisq")
[1] 49
Analysis of Variance Table

Response: speed
           Df Sum Sq Mean Sq F value Pr(>F)
nighttime   1    317  317.20  1.6606 0.1987
Residuals 244  46607  191.01               
drinkdriving$fine_outcome <- ifelse(drinkdriving$outcome == "fine", 
    1, 0)
[1] 50
drinkdriving$night_time <- ifelse(drinkdriving$nighttime == "night", 
    1, 0)
[1] 51
drinkdriving$motoring_offence <- ifelse(drinkdriving$prior_offence == 
    "N", 0, 1)
[1] 52
m5 <- glm(fine_outcome ~ age + night_time + bac + speed + motoring_offence, 
    data = drinkdriving, family = binomial)
[1] 53
summary(m5)
[1] 54

Call:
glm(formula = fine_outcome ~ age + night_time + bac + speed + 
    motoring_offence, family = binomial, data = drinkdriving)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-3.6033   0.0408   0.1696   0.4183   2.2023  

Coefficients:
                 Estimate Std. Error z value Pr(>|z|)    
(Intercept)      -4.80632    2.21178  -2.173  0.02978 *  
age              -0.04667    0.02057  -2.269  0.02328 *  
night_time       -0.14032    0.56364  -0.249  0.80339    
bac               0.19613    0.05237   3.745  0.00018 ***
speed             0.13544    0.03360   4.031 5.54e-05 ***
motoring_offence  0.37674    0.60720   0.620  0.53496    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 211.99  on 207  degrees of freedom
Residual deviance: 105.80  on 202  degrees of freedom
  (42 observations deleted due to missingness)
AIC: 117.8

Number of Fisher Scoring iterations: 6

anova(m5, test = "Chisq")
[1] 55
Analysis of Deviance Table

Model: binomial, link: logit

Response: fine_outcome

Terms added sequentially (first to last)


                 Df Deviance Resid. Df Resid. Dev  Pr(>Chi)    
NULL                               207     211.99              
age               1   64.349       206     147.64 1.042e-15 ***
night_time        1    0.643       205     147.00    0.4225    
bac               1   16.452       204     130.55 4.989e-05 ***
speed             1   24.354       203     106.19 8.015e-07 ***
motoring_offence  1    0.394       202     105.80    0.5302    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
exp(coef(m5)[c(2, 4, 5)])
[1] 56
      age       bac     speed 
0.9544055 1.2166845 1.1450436 
scale_model <- glm(fine_outcome ~ scale(bac) + scale(speed), 
    data = drinkdriving, family = binomial)
[1] 57
summary(scale_model)
[1] 58

Call:
glm(formula = fine_outcome ~ scale(bac) + scale(speed), family = binomial, 
    data = drinkdriving)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-4.0812   0.0489   0.1875   0.4458   1.9536  

Coefficients:
             Estimate Std. Error z value Pr(>|z|)    
(Intercept)    2.7886     0.3620   7.704 1.32e-14 ***
scale(bac)     1.2910     0.3076   4.197 2.71e-05 ***
scale(speed)   2.0352     0.3573   5.697 1.22e-08 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 238.69  on 242  degrees of freedom
Residual deviance: 130.13  on 240  degrees of freedom
  (7 observations deleted due to missingness)
AIC: 136.13

Number of Fisher Scoring iterations: 6

exp(coef(scale_model))
[1] 59
 (Intercept)   scale(bac) scale(speed) 
   16.258353     3.636287     7.653599 
drinkdriving <- drinkdriving[order(drinkdriving$prior_offence), 
    ]
[1] 60
offences <- drinkdriving[c(1:52, 238:245), ]
[1] 61
offences$DR50 <- ifelse(offences$prior_offence == "DR50", 1, 
    0)
[1] 62
m6 <- glm(fine_outcome ~ DR50, data = offences, family = binomial)
[1] 63
summary(m6)
[1] 64

Call:
glm(formula = fine_outcome ~ DR50, family = binomial, data = offences)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.3076   0.3803   0.3803   0.3803   0.8346  

Coefficients:
            Estimate Std. Error z value Pr(>|z|)  
(Intercept)   0.8755     0.5323   1.645   0.1000  
DR50          1.7148     0.8010   2.141   0.0323 *
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 47.121  on 59  degrees of freedom
Residual deviance: 42.358  on 58  degrees of freedom
AIC: 46.358

Number of Fisher Scoring iterations: 5

coef(summary(m5))[6, ]
[1] 65
  Estimate Std. Error    z value   Pr(>|z|) 
 0.3767402  0.6071976  0.6204573  0.5349567 
new_data <- data.frame(age = c(17:76), speed = 30, daytime = "day", 
    bac = 0, prior_offence = "None")
[1] 66
logits <- coef(m5)[1] + new_data$age * coef(m5)[2] + 30 * coef(m5)[5]
[1] 67
new_data$model_prediction <- exp(logits)/(exp(logits) + 1)
[1] 68
new_data

  age speed daytime bac prior_offence model_prediction
1  17    30     day   0          None        0.1770630
2  18    30     day   0          None        0.1703653
3  19    30     day   0          None        0.1638705
4  20    30     day   0          None        0.1575762
5  21    30     day   0          None        0.1514799
6  22    30     day   0          None        0.1455788
7  23    30     day   0          None        0.1398696
8  24    30     day   0          None        0.1343491
 [ reached 'max' / getOption("max.print") -- omitted 52 rows ]


ggplot(new_data, aes(x = age)) + geom_point(aes(y = model_prediction), 
    col = "slateblue") + theme_grey() + labs(title = "Predicted probabilities for different ages", 
    x = "- Age -", y = "Predicted Probabilities") + theme(plot.title = element_text(hjust = 0.5, 
    size = 15, face = "bold"))
[1] 70
m7 <- glm(fine_outcome ~ age * relevel(officer, "IT"), data = drinkdriving, 
    family = binomial)
[1] 71
summary(m7)
[1] 72

Call:
glm(formula = fine_outcome ~ age * relevel(officer, "IT"), family = binomial, 
    data = drinkdriving)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.7179   0.0757   0.3183   0.5638   2.4075  

Coefficients:
                              Estimate Std. Error z value Pr(>|z|)   
(Intercept)                   4.408694   1.357619   3.247  0.00116 **
age                          -0.063096   0.025175  -2.506  0.01220 * 
relevel(officer, "IT")AS      5.148426   2.417613   2.130  0.03321 * 
relevel(officer, "IT")NP      0.475849   2.013808   0.236  0.81321   
age:relevel(officer, "IT")AS -0.097924   0.042901  -2.283  0.02246 * 
age:relevel(officer, "IT")NP -0.004475   0.037058  -0.121  0.90388   
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 218.83  on 216  degrees of freedom
Residual deviance: 146.22  on 211  degrees of freedom
  (33 observations deleted due to missingness)
AIC: 158.22

Number of Fisher Scoring iterations: 6

na.omit(drinkdriving) %>% ggplot(aes(x = age, y = outcome, col = officer)) + 
    geom_jitter() + scale_x_continuous("- Age -", breaks = c(0, 
    20, 40, 60, 80, 100)) + scale_y_discrete("outcome", expand = c(0, 
    1)) + labs(title = "Who is the biased cop?") + theme_grey() + 
    theme(plot.title = element_text(hjust = 0.5, size = 15, face = "bold"))
[1] 73
