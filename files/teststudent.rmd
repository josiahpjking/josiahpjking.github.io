---
title: "teststudent"
author: "Josiah King"
date: "15/07/2020"
output: html_document
---


```{r}
library(ggplot2)  # for plotting
# deviations from the mean (from Lab 7 Solution)
outliers <- function(obs, x = 3) {
  # return TRUE if outlier, FALSE otherwise for each element of 'obs'
  return(abs(obs - mean(obs, na.rm = T)) > (sd(obs, na.rm = T) * x))
}

# To transform prior_offence data points into one of 3 levels for factorisation
bundle_offs <- function(data) {
  if (grepl("N", data)) {
    return("none")
  }
  else if (grepl("DR50", data)) {
    return("drink")
  }
  else {
    return("other")
  }
}

# Read in data ----------------------------------------------------------------
load(url("https://uoe-psychology.github.io/uoe_psystats/usmr/usmr_1920_assignment.RData"))

# =============================================================================
# Preprocessing
# =============================================================================

# Age -------------------------------------------------------------------------
# Remove implausible ages, specifically targeting three outliers ~300 noted
drinkdriving$age[drinkdriving$age > 120] <- NA
drinkdriving$age[drinkdriving$age < 12] <- NA

# Nighttime -------------------------------------------------------------------
# Transform nighttime into a logical factor instead, where:
# TRUE is "night"
drinkdriving$nighttime[drinkdriving$nighttime == "night"] <- TRUE
# FALSE is "day"
drinkdriving$nighttime[drinkdriving$nighttime == "day"] <- FALSE
# and anything else becomes NA when we formally convert to logical
drinkdriving$nighttime <- as.logical(drinkdriving$nighttime)

# Prior offence ---------------------------------------------------------------
# For use in Q3, create a new column as a three-level factor where prior
# offense history is bundled into `none`, `drink`, or `other` types
drinkdriving$prior_three <- sapply(drinkdriving$prior_offence, bundle_offs)
drinkdriving$prior_three <- as.factor(drinkdriving$prior_three)

# Additionally, create another column of logical T/F prior history
# Uses logic: if row has `none` as bundled history from last step; then False
# else True (`drink` or `other`)
drinkdriving$prior_yesno <- ifelse(drinkdriving$prior_three == "none",F, T)

# Outcome ---------------------------------------------------------------------
# Lowerise all strings to account for variation in capitalisation and
# normalise to the desired two levels as a factor
drinkdriving$outcome <- tolower(drinkdriving$outcome)
drinkdriving$outcome <- as.factor(drinkdriving$outcome)

# BAC -------------------------------------------------------------------------
# Remove outliers >3 SD above the mean for this sample (specifically targeting
# two high-end data points)
drinkdriving$bac[which(outliers(drinkdriving$bac))] <- NA

# Incident ID -----------------------------------------------------------------
# Factorize for consistency with `officer_inc` data set
drinkdriving$incident_id <- as.factor(drinkdriving$incident_id)
# Then merge the two data sets, essentially adding officer info. to the main
# data set via a join on `incident_id`s
drinkdriving <- merge(drinkdriving, officer_inc)

# =============================================================================
# QUESTION 1
# =============================================================================

m1 <- lm(bac ~ age, data = drinkdriving)

# Q1.1 ------------------------------------------------------------------------
# Explore the statistics of the model
summary(m1)

# Q1.2 ------------------------------------------------------------------------
new_age <- data.frame(age=c(50))
predict(m1, newdata = new_age)

# Q1.3 ------------------------------------------------------------------------
# Only plot Normal Q-Q
plot(m1, which=c(2))

# =============================================================================
# QUESTION 2
# =============================================================================

# Because we will be comparing models for this question, need to ensure all are
# fitted to the same size of dataset. Do this by omitting NAs in a special
# version of the dataset.
q2_data <- na.omit(drinkdriving)
# Replicate the model from Q1, but with all NAs omitted
m2A <- lm(bac ~ age, data = q2_data)

# Q2.1 ------------------------------------------------------------------------
# Scaling continous predictors because they use different units from here on.

# Create a model with age and time of day as predictors
m2B <- lm(bac ~ age + nighttime, data = q2_data)
# Compare versus baseline with just age
anova(m2A, m2B)

# Create a model with age and speed of driving as predictors
m2C <- lm(bac ~ age + scale(speed), data = q2_data)
# Compare versus baseline with just age
anova(m2A, m2C)

# Q2.2 ------------------------------------------------------------------------
# Use summary to display r-squared values for each to assess explanation of
# variance in BAC
summary(m2A)
summary(m2B)
summary(m2C)

# Q2.3 ------------------------------------------------------------------------
# Compare means of speeds at nighttime and speeds at daytime
with(drinkdriving, t.test(speed ~ nighttime))

# =============================================================================
# QUESTION 3
# =============================================================================

# Q3.1 ------------------------------------------------------------------------
# Fit a generalised linear model with all possible predictors
m3A <- glm(outcome ~ scale(age) + nighttime + scale(speed) + scale(bac) + prior_three, data = drinkdriving, family = binomial)
summary(m3A)

# Q3.2 ------------------------------------------------------------------------
# Create a simplified version of the main dataset where have only the prior
# offence histories of interest: those which are `drink` or `other`
q3_data <- drinkdriving[! drinkdriving$prior_three == "none", ]
q3_data <- droplevels(q3_data)

# Spin up the contingency table and run the Chi-Squared test
tbl <- table(q3_data$outcome, q3_data$prior_three)
chisq.test(tbl)

# Q3.3 ------------------------------------------------------------------------
# Run another Chi-Squared test but with binary prior offence history
tbl2 <- table(drinkdriving$outcome, drinkdriving$prior_yesno)
chisq.test(tbl2)


# =============================================================================
# QUESTION 4
# =============================================================================

# Create a dataframe across range of ages with provided constants
# Use the actual top-end of drivers in the dataset
q4_data <- data.frame(age=c(17:90),
                      nighttime=c(F),
                      speed=c(30),
                      bac=c(0),
                      prior_three=c("none"))

# Use imported function to apply M3A model with all possible predictors
# https://rdrr.io/cran/modelr/man/add_predictions.html

# =============================================================================
# QUESTION 5
# =============================================================================

# For each, create a data frame with only the given officer's incidents
# then run a t-test of age against outcome and plot a box plot

offAS <- drinkdriving[drinkdriving$officer == "AS", ]
with(offAS, t.test(age ~ outcome))
with(offAS, plot(outcome, age))

offIT <- drinkdriving[drinkdriving$officer == "IT", ]
with(offIT, t.test(age ~ outcome))
with(offIT, plot(outcome, age))

offNP <- drinkdriving[drinkdriving$officer == "NP", ]
with(offNP, t.test(age ~ outcome))
with(offNP, plot(outcome, age))

# -----------------------------------------------------------------------------
# END
# -----------------------------------------------------------------------------

```

